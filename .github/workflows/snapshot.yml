name: Snapshot

on:
  push:
    tags:
      - 'snapshot/*'

permissions:
  contents: write

jobs:
  build-zip:
    name: Build snapshot ZIP
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set build variables
        id: buildvars
        shell: bash
        run: |
          GIT_TAG="${GITHUB_REF_NAME}"
          GIT_VER="${GIT_TAG#snapshot/}"
          echo "GIT_VER=$GIT_VER" >> $GITHUB_ENV
          echo "GIT_TAG=$GIT_TAG" >> $GITHUB_ENV

      - name: Stage scripts
        shell: bash
        run: |
          STAGE="build/scripts/ethos-arcade"
          mkdir -p "$STAGE"
          rsync -a src/ethos-arcade/ "$STAGE"/
          echo "STAGE=$STAGE" >> $GITHUB_ENV

      - name: Create snapshot ZIP
        shell: bash
        run: |
          ART="ethos-arcade-${{ env.GIT_VER }}.zip"
          (cd build && zip -q -r -9 "../$ART" scripts)
          echo "ARTIFACT=$ART" >> $GITHUB_ENV

      - name: Create snapshot notes
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build notes
        shell: bash
        run: |
          python .github/scripts/extract-release-notes.py "${{ env.GIT_VER }}" Releases.md > Notes.md
          sed -n '1,200p' Notes.md

      - name: Create Snapshot Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          gh release create "${{ env.GIT_TAG }}" \
            --prerelease \
            --notes-file Notes.md \
            --title "Ethos Arcade - Snapshot ${{ env.GIT_VER }}" \
            "${{ env.ARTIFACT }}"
